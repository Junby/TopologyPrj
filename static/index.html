<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>动态生成拓扑图</title>
</head>
<script src="/TopologyPrj/js/jquery-1.9.1.min.js"></script>
<script src="/TopologyPrj/js/raphael.min.js"></script>
<script src="/TopologyPrj/js/bootstrap.min.js"></script>
<link href="/TopologyPrj/css/bootstrap.css" rel="stylesheet">
<style type="text/css">
    #frame{
        width:700px;
        height:600px;
        border:1px solid gray;
        border-radius:5px;
        position:relative;
        margin:20px;
    }
</style>
<body>
<div id="frames"></div>
</body>
<script>

    function createVmTopology(ele,data,width,height){
        var t = new Topology(ele,width,height);
        t.setTop();
        t.setTopRect();
        t.setVmRect(data);
        t.setBottomRect();
        t.setCenterRect();
        t.setVolume(data);
        t.setNetwork(data);
        t.connection(t.obj.cenObj, t.obj.vmObj);
        t.connection(t.obj.botObj, t.obj.vmObj);
        for(var i = 0; i < t.volumeObj.length; i++){
            t.parallelDownConnection(t.obj.botObj,t.volumeObj[i]);
        }
        for(var i = 0; i < t.networkObj.length; i++){
            t.parallelUpConnection(t.obj.cenObj,t.networkObj[i]);
        }
    }

    function cheatObj(x,y,w,h){
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
    }

    function createVolume(instanceId) {
        alert(instanceId);
    }
    function createVMPopover(data){
            var title = '<div style="text-align:center; color:red; text-decoration:underline; font-size:14px;">'+data.name+'</div>'; //this is the top title bar of the popover. add some basic css
            var status = initStatus(data.status);
            var template = '<div><label>模板：</label><a href="xxx/'+data.templateId+'">'+data.templateName+'</a></div>';
            var content = '<div id="content"><div><label>名字：</label><span>'+data.name+'</span></div>'+status + template +'</div>';
            var thisA = $('.vmClass');
            $(".vmClass").popover({
                container: 'body',
                trigger:'manual',
                placement : 'right', //placement of the popover. also can use top, bottom, left or right
                title : title,
                html: 'true', //needed to show html of course
//                content : '<div id="popOverBox"><img src="http://www.hd-report.com/wp-content/uploads/2008/08/mr-evil.jpg" width="251" height="201" /></div>', //this is the content of the html box. add the image here or anything you want really.
                content : content,
                animation: false
            }).on("mouseenter", function () {
                var _this = this;
                $(this).popover("show");
                $(this).siblings(".popover").on("mouseleave", function () {
                    $(_this).popover('hide');
                });
                thisA.attr("stroke","#59cbdb");
            }).on("mouseleave", function () {
//            var _this = this;
//            setTimeout(function () {
//                if (!$(".popover:hover").length) {
//                    $(_this).popover("hide")
//                }
//            }, 100);
                thisA.attr("stroke","#d5dee2");
        });

        $("body").on("mousewheel click",function(){
            if($(".vmClass").length){
                $(".vmClass").popover("hide");
            }
        });
    }

    function initStatus(status){
        if(status){

        }
        return '<div><label>状态：</label><span class="">运行中</span></div>';
    }

    function Topology(ele,width,height) {
        var width = width;
        var height = height;
        if (!width) {
            width = 700;
        }
        if (!height) {
            height = 600;
        }

        this.raphael = Raphael(ele, width, height);
        this.width = width;
        this.height = height;
        this.padding = 20;
        this.topPadding = null;
        this.rate = 7;
        this.objW = this.width / this.rate;
        this.objH = this.height / (this.rate + 2);
        this.src = {
            pubSrc: "https://console.ustack.com/static/modules/instance/i/icon-public-network.png",
            vmSrc: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_opensuse.png",
            defaultSrc: "https://console.ustack.com/static/modules/instance/i/icon-network.png",
            volumeSrc: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_windows.png"
        };
        this.color = ["#59cbdb", "#d5dee2", "#7f7f7f"];
        this.obj = {};
        this.volumeObj = [];
        this.networkObj = []

    }

    Topology.prototype.setTop = function(src){
        var img = src ? src : this.src.pubSrc;
        var x = this.width / 2 - this.objW / 2;
        var y = this.padding;
        this.topPadding = this.padding + this.objH;
        this.raphael.image(img,x,y,this.objW,this.objH);
    }

    Topology.prototype.setTopRect = function(){
        this.raphael.rect(0,this.topPadding,this.width,5,2).attr({fill : this.color[0],stroke : this.color[0]});
        var obj = new cheatObj(0,this.topPadding,this.width,5);
        this.obj.topObj = obj;
    }

    Topology.prototype.setVmRect = function(data,src){
        var x = this.width / 2 - this.objW / 2;
        var y = this.height / 3 * 2 - this.objH / 2 ;
        var img = src ? src : this.src.vmSrc;
        var img_w = 30,img_h = 30;
        var img_x = (2 * x + this.objW) / 2 - img_w / 2;
        var img_y = y + this.padding / 4;
        var text_x = this.width / 2;
        var text_y = y + this.objH - this.padding / 2;

        var name = data ? data.name : "vm";
        this.raphael.rect(x,y,this.objW,this.objH,2).attr({stroke : this.color[1],fill:"white",class : 'vmClass'});
        this.raphael.image(img,img_x,img_y,img_w,img_h);
        this.raphael.text(text_x,text_y,name).attr({ fill : "#000", "font-size" : 13 });
        var obj = new cheatObj(x,y,this.objW,this.objH);
        this.obj.vmObj = obj;
        createVMPopover(data);
    }

    Topology.prototype.setBottomRect = function(){
        var rate = 1.5;
        var space = (this.width - this.width / rate) / 2;
        var y = this.obj.vmObj.y + this.obj.vmObj.h + 2 * this.padding;
        this.raphael.rect(space,y,this.width / rate,5,2).attr({fill : this.color[0],stroke : this.color[0]});
        var obj = new cheatObj(space,y,this.width / rate,5);
        this.obj.botObj = obj;
    }

    Topology.prototype.setCenterRect = function(){
        var rate = 1.5;
        var space = (this.width - this.width / rate) / 2;
        var y = this.obj.vmObj.y - 2 * this.padding;
        this.raphael.rect(space,y,this.width / rate,5,2).attr({fill : this.color[0],stroke : this.color[0]});
        var obj = new cheatObj(space,y,this.width / rate,5);
        this.cenObj = obj;
        this.obj.cenObj = obj;
    }

    Topology.prototype.setVolume = function(detail){
        var data = detail.volume;
        var i = data.length + 1;
        var rate = i * 2;
        var x_index = [];
        var y = this.height - this.objH -this.padding;
        var length = this.obj.botObj.w / rate;
        for(var m = 1; m <= rate; m++){
            if(m % 2 != 0){
                var x = this.obj.botObj.x + length * m;
                x_index.push(x);
            }
        }

        for(var m = 0;m <= data.length; m++){
            var x = x_index[m] - this.objW / 2;
            if(m != data.length){
                this.setVolumeImg(x,y,data[m]);
            }else{
                var i = this.setVolumeImg(x,y);
                i.click(function(){
                    //click action
                    createVolume(detail.id);
                });
            }
        }
    }

    Topology.prototype.setNetwork = function(detail){
        var data = detail.nic;
        var rate = data.length * 2;
        var x_index = [];
        var y = this.obj.cenObj.y - 2 * this.objH ;
        var length = this.obj.cenObj.w / rate;
        for(var m = 1; m <= rate; m++){
            if(m % 2 != 0){
                var x = this.obj.cenObj.x + length * m;
                x_index.push(x);
            }
        }

        for(var m = 0;m < data.length; m++){
            var x = x_index[m] - this.objW / 2;
            this.setNetworkImg(detail.id,x,y,data[m]);
        }
    }

    Topology.prototype.setVolumeImg = function(x,y,data,src){
        var img_src = src ? src : this.src.volumeSrc;
        var i = this.raphael.image(img_src,x,y,this.objW,this.objH);
        if(data){
            this.raphael.text(x + this.objW / 2,y + this.padding / 2 + this.objH,data.name);
        }
        var obj = new cheatObj(x,y,this.objW,this.objH);
        this.volumeObj.push(obj);
        return i;
    }

    Topology.prototype.setNetworkImg = function(instanceId,x,y,data,src){
        var img_src = src ? src : this.src.defaultSrc;
        var i = this.raphael.image(img_src,x,y,this.objW,this.objH);
        if(data){
            this.raphael.text(x + this.objW + this.padding,y + this.objH,data.name);
        }
        var obj = new cheatObj(x,y,this.objW,this.objH);
        this.networkObj.push(obj);
        if(data.default){
            this.addPublicIp(instanceId,obj);
//            i.click(function(){
//                createVolume(instanceId);
//            });
        }
    }

    Topology.prototype.addPublicIp = function(instanceId,obj){
        var x = obj.x, y = (obj.y + this.obj.topObj.y) / 2, w = obj.w, h = 20;
        var r = this.raphael.rect(x,y,w,h,2).attr({fill : 'white',stroke : this.color[1],class : "dash"});
        var i = this.raphael.text(x + w/2,y + h/2,'绑定公网IP');
        $(".dash").attr("stroke-dasharray","10");
        var pubObj = new cheatObj(x,y,w,h);
        this.connection(obj,pubObj);
        this.parallelDownConnection(pubObj,this.obj.topObj);
        r.click(function(){
            createVolume(instanceId);
        });
        i.click(function(){
            createVolume(instanceId);
        });
    }


    Topology.prototype.connection = function(obj1,obj2){
        var x1 = obj1.x,x2 = obj2.x,y1 = obj1.y,y2 = obj2.y;

        if(y1 < y2){
            x1 = obj1.x + obj1.w / 2;
            y1 = obj1.y + obj1.h;
            x2 = obj2.x + obj2.w / 2;
            y2 = obj2.y;
        }else{
            x1 = obj1.x + obj1.w / 2;
            y1 = obj1.y;
            x2 = obj2.x + obj2.w / 2;
            y2 = obj2.y + obj2.h;
        }

        var path = [ "M", x1, y1, "L", x2, y2 ].join(",");
        this.raphael.path(path).attr({fill: "none", stroke: this.color[2],"stroke-width" : 1});
    }

    Topology.prototype.parallelDownConnection = function(obj1,obj2){
        var x1 = obj1.x,x2 = obj2.x,y1 = obj1.y,y2 = obj2.y;

        if(y1 < y2){
            x1 = obj2.x + obj2.w / 2;
            y1 = obj1.y + obj1.h;
            x2 = obj2.x + obj2.w / 2;
            y2 = obj2.y;
        }else{
            x1 = obj1.x + obj1.w / 2;
            y1 = obj1.y;
            x2 = obj1.x + obj1.w / 2;
            y2 = obj2.y + obj2.h;
        }

        var path = [ "M", x1, y1, "L", x2, y2 ].join(",");
        this.raphael.path(path).attr({fill: "none", stroke: this.color[2],"stroke-width" : 1});
    }

    Topology.prototype.parallelUpConnection = function(obj1,obj2){
        var x1 = obj1.x,x2 = obj2.x,y1 = obj1.y,y2 = obj2.y;

        if(y1 < y2){
            x1 = obj1.x + obj1.w / 2;
            y1 = obj2.y ;
            x2 = obj1.x + obj1.w / 2;
            y2 = obj1.y+ obj1.h;
        }else{
            x1 =  obj2.x + obj2.w / 2;
            y1 = obj1.y;
            x2 = obj2.x + obj2.w / 2;
            y2 = obj2.y + obj2.h;
        }

        var path = [ "M", x1, y1, "L", x2, y2 ].join(",");
        this.raphael.path(path).attr({fill: "none", stroke: this.color[2],"stroke-width" : 1});
    }

</script>
<script>
    $(function(){
        var data = {
            success : true,
            message : "",
            data : {
                name : "vm-test",
                id : "id",
                status : "running",
                publicIp : "ip",
                templateName : "templateName",
                templateId : "tId",
                nic : [
                    {
                        id : "id1",
                        name : "net1",
                        ip : "ip1",
                        default : true,
                        type : "isolate"
                    }
                ],
                volume : [
                    {
                        id : "id",
                        name : "root",
                        size : 20,
                        type : "root"
                    }
                ]
            }
        }

        createVmTopology("frames",data.data,600,500);

    });
</script>
</html>