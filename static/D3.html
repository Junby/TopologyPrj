<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<script src="/TopologyPrj/js/jquery-3.1.0.min.js"></script>
<script src="/TopologyPrj/js/d3.js"></script>
<style type="text/css">
    .link { stroke: green; stroke-linejoin:bevel;}

    .link_error{
        stroke:red;
        stroke-linejoin:bevel;
    }

    .nodetext {

        font: 12px sans-serif;
        -webkit-user-select:none;
        -moze-user-select:none;
        stroke-linejoin:bevel;

    }

    .container{
        width:500px;
        height:500px;
        border:1px solid gray;
        border-radius:5px;
        position:relative;
        margin:20px;
    }

    .linetext {
        font-size: 12px ;
        font-family: SimSun;
        fill:red;
        fill-opacity:0.0;
    }
</style>
<body>
<script>


    var nodes = [
        { name: "network",image: "https://console.ustack.com/static/modules/instance/i/icon-network.png"},
        { name: "vm1",image: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_opensuse.png"},
        { name: "vm2" ,image: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_opensuse.png"},
        { name: "vm3" ,image: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_opensuse.png"},
        { name: "data1",image: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_windows.png"},
        { name: "root1",image: "https://console.ustack.com/static/modules/instance/i/images/single-icon/image_windows.png"}];

    var edges = [
        { source : 0  , target: 1 , relation:"VM" } ,
        { source : 0  , target: 2 , relation:"VM"  } ,
        { source : 0  , target: 3 , relation:"VM"  } ,
        { source : 1  , target: 4 , relation:"volume" } ,
        { source : 1  , target: 5 , relation:"volume" } ];

    var width = 400;
    var height = 400;
    var img_w = 77;
    var img_h = 90;


    var svg = d3.select("body")
            .append("svg").attr("class","container");

    var force = d3.layout.force()
            .nodes(nodes)		//指定节点数组
            .links(edges)		//指定连线数组
            .size([width,height])	//指定范围
            .linkDistance(200)	//指定连线长度
            .charge(-800);	//相互之间的作用力

    force.start();	//开始作用

    console.log(nodes);
    console.log(edges);

    //添加连线
    var svg_edges = svg.selectAll("line")
            .data(edges)
            .enter()
            .append("line")
            .style("stroke","#59cbdb")
            .style("stroke-width",2);

    var color = d3.scale.category20();

    //添加节点
    var svg_nodes = svg.selectAll("image")
            .data(nodes)
            .enter()
            .append("image")
            .attr("width",img_w)
            .attr("height",img_h)
            .attr("xlink:href",function(d){
                return d.image;
            }).on("mouseover",function(d,i){
                //显示连接线上的文字
                edges_text.style("fill-opacity",function(edge){
                    if( edge.source === d || edge.target === d ){
                        return 1.0;
                    }
                });
            })
            .on("mouseout",function(d,i){
                //隐去连接线上的文字
                edges_text.style("fill-opacity",function(edge){
                    if( edge.source === d || edge.target === d ){
                        return 0.0;
                    }
                });
            });

    //添加描述节点的文字
    var svg_texts = svg.selectAll("text")
            .data(nodes)
            .enter()
            .append("text")
            .style("fill", "black")
            .attr("dx", 20)
            .attr("dy", 8)
            .text(function(d){
                return d.name;
            });

    //添加连接线上文字
    var edges_text = svg.selectAll(".linetext")
            .data(edges)
            .enter()
            .append("text")
            .attr("class","linetext")
            .text(function(d){
                return d.relation;
            });


    force.on("tick", function(){	//对于每一个时间间隔

        //限制结点的边界
        nodes.forEach(function(d,i){
            d.x = d.x - img_w/2 < 0     ? img_w/2 : d.x ;
            d.x = d.x + img_w/2 > width ? width - img_w/2 : d.x ;
            d.y = d.y - img_h/2 < 0      ? img_h/2 : d.y ;
        });


        //更新连线坐标
        svg_edges.attr("x1",function(d){ return d.source.x; })
                .attr("y1",function(d){ return d.source.y; })
                .attr("x2",function(d){ return d.target.x; })
                .attr("y2",function(d){ return d.target.y; });

        //更新节点坐标

        svg_nodes.attr("x",function(d){ return d.x - img_w/2; });
        svg_nodes.attr("y",function(d){ return d.y - img_h/2; });

        //更新文字坐标
        svg_texts.attr("x", function(d){ return d.x; })
                .attr("y", function(d){ return d.y; });

        //更新连接线上文字的位置
        edges_text.attr("x",function(d){ return (d.source.x + d.target.x) / 2 ; });
        edges_text.attr("y",function(d){ return (d.source.y + d.target.y) / 2 ; });

    });


</script>
</body>
</html>